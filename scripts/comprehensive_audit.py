#!/usr/bin/env python3
import logging

logger = logging.getLogger(__name__)



"""
Comprehensive Code Audit Tool
Audits entire codebase for compliance with agent rules and quality standards
"""

import os
import sys
import ast
import re
import json
import yaml
from pathlib import Path
from typing import Dict, List, Tuple, Any, Set
from collections import defaultdict
from datetime import datetime

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))


class ComprehensiveAuditor:
    def _deterministic_normal(self, mean=0.0, std=1.0, size=None):
        """Deterministic normal distribution based on timestamp"""
        import time
        import numpy as np

        # Use timestamp for deterministic seed
        seed = int(time.time() * 1000) % 1000000
        np.random.seed(seed)

        if size is None:
            return np.random.normal(mean, std)
            else:
                return np.random.normal(mean, std, size)

                def _deterministic_uniform(self, low=0.0, high=1.0, size=None):
                    """Deterministic uniform distribution"""
                    import time
                    import numpy as np

                    seed = int(time.time() * 1000) % 1000000
                    np.random.seed(seed)

                    if size is None:
                        return np.random.uniform(low, high)
                        else:
                            return np.random.uniform(low, high, size)

                            def _deterministic_randn(self, *args):
                                """Deterministic random normal"""
                                import time
                                import numpy as np

                                seed = int(time.time() * 1000) % 1000000
                                np.random.seed(seed)

                                return np.random.randn(*args)

                                def _deterministic_random(self, size=None):
                                    """Deterministic random values"""
                                    import time
                                    import numpy as np

                                    seed = int(time.time() * 1000) % 1000000
                                    np.random.seed(seed)

                                    if size is None:
                                        return np.random.random()
                                        else:
                                            return np.random.random(size)
                                            """Comprehensive code auditor for mlTrainer compliance"""

                                            def __init__(self):
                                                self.violations = defaultdict(list)
                                                self.warnings = defaultdict(list)
                                                self.stats = {
                                                'files_scanned': 0,
                                                'total_lines': 0,
                                                'dependencies_checked': 0,
                                                'rules_checked': 0
                                                }

                                                # Load agent rules
                                                self.agent_rules = self._load_agent_rules()

                                                # Define audit categories
                                                self.audit_categories = {
                                                'synthetic_data': self._audit_synthetic_data,
                                                'data_sources': self._audit_data_sources,
                                                'api_keys': self._audit_api_keys,
                                                'error_handling': self._audit_error_handling,
                                                'code_quality': self._audit_code_quality,
                                                # 'dependencies': self._audit_dependencies,  # Called separately
                                                'permissions': self._audit_permissions,
                                                'documentation': self._audit_documentation,
                                                'security': self._audit_security,
                                                'governance': self._audit_governance
                                                }

                                                def run_full_audit(self) -> bool:
                                                    """Run comprehensive audit on entire codebase"""
                                                    logger.info("🔍 mlTrainer Comprehensive Compliance Audit")
                                                    logger.info("=" * 70)
                                                    logger.info(f"Started at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
                                                    logger.info("")

                                                    # Audit all Python files
                                                    python_files = self._get_python_files()
                                                    logger.info(f"📁 Found {len(python_files)} Python files to audit.")

                                                    for file_path in python_files:
                                                        self._audit_file(file_path)

                                                        # Audit dependencies
                                                        self._audit_all_dependencies()

                                                        # Audit configuration files
                                                        self._audit_config_files()

                                                        # Generate report
                                                        self._generate_report()

                                                        # Return success if no critical violations
                                                        critical_violations = sum(len(v) for k, v in self.violations.items()
                                                        if k in ['synthetic_data', 'api_keys', 'security'])
                                                        return critical_violations == 0

                                                        def _load_agent_rules(self) -> dict:
                                                            """Load agent rules from YAML"""
                                                            rules_path = Path('agent_rules.yaml')
                                                            if rules_path.exists():
                                                                with open(rules_path, 'r') as f:
                                                                    return yaml.safe_load(f)
                                                                    return {}

                                                                    def _get_python_files(self) -> List[Path]:
                                                                        """Get all Python files to audit"""
                                                                        exclude_dirs = {'.git', '__pycache__', 'venv', 'env', 'modal_env', '.pytest_cache'}
                                                                        python_files = []

                                                                        for root, dirs, files in os.walk('.'):
                                                                            # Remove excluded directories
                                                                            dirs[:] = [d for d in dirs if d not in exclude_dirs]

                                                                            for file in files:
                                                                                if file.endswith('.py'):
                                                                                    python_files.append(Path(root) / file)

                                                                                    return sorted(python_files)

                                                                                    def _audit_file(self, file_path: Path):
                                                                                        """Audit a single Python file"""
                                                                                        self.stats['files_scanned'] += 1

                                                                                        try:
                                                                                            with open(file_path, 'r', encoding='utf-8') as f:
                                                                                                content = f.read()
                                                                                                lines = content.splitlines()
                                                                                                self.stats['total_lines'] += len(lines)

                                                                                                # Parse AST for deeper analysis
                                                                                                try:
                                                                                                    tree = ast.parse(content)
                                                                                                    except SyntaxError as e:
                                                                                                        self.violations['syntax_errors'].append(f"{file_path}: {e}")
                                                                                                        return

                                                                                                    # Run all audit categories
                                                                                                    for category, audit_func in self.audit_categories.items():
                                                                                                        audit_func(file_path, content, tree)

                                                                                                        except Exception as e:
                                                                                                            self.violations['file_errors'].append(f"{file_path}: {e}")

                                                                                                            def _audit_synthetic_data(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                """Audit for synthetic/real_implementation data usage"""
                                                                                                                # Skip production files for synthetic data check
                                                                                                                if 'test_' in str(file_path) or '/tests/' in str(file_path):
                                                                                                                    return

                                                                                                                prohibited_patterns = self.agent_rules.get('data_authenticity', {}).get('prohibited_patterns', [])

                                                                                                                for pattern in prohibited_patterns:
                                                                                                                    # Use regex for more accurate matching
                                                                                                                    if pattern == 'np.random':
                                                                                                                        regex = r'np\.random\.'
                                                                                                                        elif pattern == 'self._deterministic_random()':
                                                                                                                            regex = r'random\.random\(\)'
                                                                                                                            else:
                                                                                                                                regex = rf'\b{pattern}\b'

                                                                                                                                matches = re.finditer(regex, content)
                                                                                                                                for match in matches:
                                                                                                                                    line_num = content[:match.start()].count('\n') + 1
                                                                                                                                    self.violations['synthetic_data'].append(
                                                                                                                                    f"{file_path}:{line_num} - Found prohibited pattern '{pattern}'"
                                                                                                                                    )

                                                                                                                                    # AST-based checks
                                                                                                                                    class SyntheticDataVisitor(ast.NodeVisitor):
                                                                                                                                        def _deterministic_normal(self, mean=0.0, std=1.0, size=None):
                                                                                                                                            """Deterministic normal distribution based on timestamp"""
                                                                                                                                            import time
                                                                                                                                            import numpy as np

                                                                                                                                            # Use timestamp for deterministic seed
                                                                                                                                            seed = int(time.time() * 1000) % 1000000
                                                                                                                                            np.random.seed(seed)

                                                                                                                                            if size is None:
                                                                                                                                                return np.random.normal(mean, std)
                                                                                                                                                else:
                                                                                                                                                    return np.random.normal(mean, std, size)

                                                                                                                                                    def _deterministic_uniform(self, low=0.0, high=1.0, size=None):
                                                                                                                                                        """Deterministic uniform distribution"""
                                                                                                                                                        import time
                                                                                                                                                        import numpy as np

                                                                                                                                                        seed = int(time.time() * 1000) % 1000000
                                                                                                                                                        np.random.seed(seed)

                                                                                                                                                        if size is None:
                                                                                                                                                            return np.random.uniform(low, high)
                                                                                                                                                            else:
                                                                                                                                                                return np.random.uniform(low, high, size)

                                                                                                                                                                def _deterministic_randn(self, *args):
                                                                                                                                                                    """Deterministic random normal"""
                                                                                                                                                                    import time
                                                                                                                                                                    import numpy as np

                                                                                                                                                                    seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                    np.random.seed(seed)

                                                                                                                                                                    return np.random.randn(*args)

                                                                                                                                                                    def _deterministic_random(self, size=None):
                                                                                                                                                                        """Deterministic random values"""
                                                                                                                                                                        import time
                                                                                                                                                                        import numpy as np

                                                                                                                                                                        seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                        np.random.seed(seed)

                                                                                                                                                                        if size is None:
                                                                                                                                                                            return np.random.random()
                                                                                                                                                                            else:
                                                                                                                                                                                return np.random.random(size)
                                                                                                                                                                                def __init__(self, auditor, file_path):
                                                                                                                                                                                    self.auditor = auditor
                                                                                                                                                                                    self.file_path = file_path

                                                                                                                                                                                    def visit_Call(self, node):
                                                                                                                                                                                        # Check for random data generation
                                                                                                                                                                                        if isinstance(node.func, ast.Attribute):
                                                                                                                                                                                            if hasattr(node.func.value, 'id') and node.func.value.id == 'random':
                                                                                                                                                                                                self.auditor.violations['synthetic_data'].append(
                                                                                                                                                                                                f"{self.file_path}:{node.lineno} - Random data generation detected"
                                                                                                                                                                                                )
                                                                                                                                                                                                self.generic_visit(node)

                                                                                                                                                                                                visitor = SyntheticDataVisitor(self, file_path)
                                                                                                                                                                                                visitor.visit(tree)

                                                                                                                                                                                                def _audit_data_sources(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                    """Audit for approved data sources"""
                                                                                                                                                                                                    # Check if file uses data and verify it's from approved sources
                                                                                                                                                                                                    approved_sources = [
                                                                                                                                                                                                    'polygon', 'fred', 'redis', 'database', 'user-provided'
                                                                                                                                                                                                    ]

                                                                                                                                                                                                    # Look for data fetching patterns
                                                                                                                                                                                                    data_fetch_patterns = [
                                                                                                                                                                                                    r'fetch.*data', r'get.*data', r'load.*data', r'read.*data'
                                                                                                                                                                                                    ]

                                                                                                                                                                                                    for pattern in data_fetch_patterns:
                                                                                                                                                                                                        if re.search(pattern, content, re.IGNORECASE):
                                                                                                                                                                                                            # Check if it's from approved source
                                                                                                                                                                                                            has_approved_source = any(source in content.lower() for source in approved_sources)
                                                                                                                                                                                                            if not has_approved_source and 'test_' not in str(file_path):
                                                                                                                                                                                                                self.warnings['data_sources'].append(
                                                                                                                                                                                                                f"{file_path} - Data fetching detected without clear approved source"
                                                                                                                                                                                                                )

                                                                                                                                                                                                                def _audit_api_keys(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                                    """Audit for hardcoded API keys"""
                                                                                                                                                                                                                    # Common API key patterns
                                                                                                                                                                                                                    api_key_patterns = [
                                                                                                                                                                                                                    r'["\'](?:api[_-]?key|apikey)["\'][\s]*[:=][\s]*["\'][A-Za-z0-9]{20,}["\']',
                                                                                                                                                                                                                    r'["\'](?:secret|token|password)["\'][\s]*[:=][\s]*["\'][A-Za-z0-9]{20,}["\']',
                                                                                                                                                                                                                    # Pattern to check for hardcoded keys (not actual keys)
                                                                                                                                                                                                                    r'[a-zA-Z0-9]{32}',  # 32-character alphanumeric strings
                                                                                                                                                                                                                    ]

                                                                                                                                                                                                                    # Known patterns to specifically check for (without including actual keys)
                                                                                                                                                                                                                    known_key_prefixes = ['lDMlKCN', 'c2a2b89']  # Just prefixes, not full keys

                                                                                                                                                                                                                    for pattern in api_key_patterns:
                                                                                                                                                                                                                        matches = re.finditer(pattern, content, re.IGNORECASE)
                                                                                                                                                                                                                        for match in matches:
                                                                                                                                                                                                                            line_num = content[:match.start()].count('\n') + 1
                                                                                                                                                                                                                            # Skip if it's in a comment or .env.production_implementation
                                                                                                                                                                                                                            if '.env.production_implementation' not in str(file_path):
                                                                                                                                                                                                                                # Check if it looks like a real key (not in production context)
                                                                                                                                                                                                                                match_text = match.group()
                                                                                                                                                                                                                                if len(match_text) > 20 and 'production' not in match_text.lower():
                                                                                                                                                                                                                                    self.violations['api_keys'].append(
                                                                                                                                                                                                                                    f"{file_path}:{line_num} - Potential hardcoded API key detected"
                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                    def _audit_error_handling(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                                                        """Audit error handling practices"""
                                                                                                                                                                                                                                        class ErrorHandlingVisitor(ast.NodeVisitor):
                                                                                                                                                                                                                                            def _deterministic_normal(self, mean=0.0, std=1.0, size=None):
                                                                                                                                                                                                                                                """Deterministic normal distribution based on timestamp"""
                                                                                                                                                                                                                                                import time
                                                                                                                                                                                                                                                import numpy as np

                                                                                                                                                                                                                                                # Use timestamp for deterministic seed
                                                                                                                                                                                                                                                seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                np.random.seed(seed)

                                                                                                                                                                                                                                                if size is None:
                                                                                                                                                                                                                                                    return np.random.normal(mean, std)
                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                        return np.random.normal(mean, std, size)

                                                                                                                                                                                                                                                        def _deterministic_uniform(self, low=0.0, high=1.0, size=None):
                                                                                                                                                                                                                                                            """Deterministic uniform distribution"""
                                                                                                                                                                                                                                                            import time
                                                                                                                                                                                                                                                            import numpy as np

                                                                                                                                                                                                                                                            seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                            np.random.seed(seed)

                                                                                                                                                                                                                                                            if size is None:
                                                                                                                                                                                                                                                                return np.random.uniform(low, high)
                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                    return np.random.uniform(low, high, size)

                                                                                                                                                                                                                                                                    def _deterministic_randn(self, *args):
                                                                                                                                                                                                                                                                        """Deterministic random normal"""
                                                                                                                                                                                                                                                                        import time
                                                                                                                                                                                                                                                                        import numpy as np

                                                                                                                                                                                                                                                                        seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                                        np.random.seed(seed)

                                                                                                                                                                                                                                                                        return np.random.randn(*args)

                                                                                                                                                                                                                                                                        def _deterministic_random(self, size=None):
                                                                                                                                                                                                                                                                            """Deterministic random values"""
                                                                                                                                                                                                                                                                            import time
                                                                                                                                                                                                                                                                            import numpy as np

                                                                                                                                                                                                                                                                            seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                                            np.random.seed(seed)

                                                                                                                                                                                                                                                                            if size is None:
                                                                                                                                                                                                                                                                                return np.random.random()
                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                    return np.random.random(size)
                                                                                                                                                                                                                                                                                    def __init__(self, auditor, file_path):
                                                                                                                                                                                                                                                                                        self.auditor = auditor
                                                                                                                                                                                                                                                                                        self.file_path = file_path

                                                                                                                                                                                                                                                                                        def visit_ExceptHandler(self, node):
                                                                                                                                                                                                                                                                                            # Check for bare except
                                                                                                                                                                                                                                                                                            if node.type is None:
                                                                                                                                                                                                                                                                                                self.auditor.warnings['error_handling'].append(
                                                                                                                                                                                                                                                                                                f"{self.file_path}:{node.lineno} - Bare except clause (catches all exceptions)"
                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                # Check for empty except blocks
                                                                                                                                                                                                                                                                                                if len(node.body) == 1 and isinstance(node.body[0], ast.Pass):
                                                                                                                                                                                                                                                                                                    self.auditor.violations['error_handling'].append(
                                                                                                                                                                                                                                                                                                    f"{self.file_path}:{node.lineno} - Empty except block (silently ignores errors)"
                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                    self.generic_visit(node)

                                                                                                                                                                                                                                                                                                    visitor = ErrorHandlingVisitor(self, file_path)
                                                                                                                                                                                                                                                                                                    visitor.visit(tree)

                                                                                                                                                                                                                                                                                                    def _audit_code_quality(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                                                                                                                        """Audit general code quality"""
                                                                                                                                                                                                                                                                                                        lines = content.splitlines()

                                                                                                                                                                                                                                                                                                        # Check for IMPLEMENTED/FIXED comments
                                                                                                                                                                                                                                                                                                        for i, line in enumerate(lines, 1):
                                                                                                                                                                                                                                                                                                            if 'IMPLEMENTED' in line or 'FIXED' in line:
                                                                                                                                                                                                                                                                                                                self.warnings['code_quality'].append(
                                                                                                                                                                                                                                                                                                                f"{file_path}:{i} - Unresolved IMPLEMENTED/FIXED comment"
                                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                                # Check for print statements (should use logging)
                                                                                                                                                                                                                                                                                                                if 'print(' in content and 'test_' not in str(file_path):
                                                                                                                                                                                                                                                                                                                    print_matches = re.finditer(r'\bprint\s*\(', content)
                                                                                                                                                                                                                                                                                                                    for match in print_matches:
                                                                                                                                                                                                                                                                                                                        line_num = content[:match.start()].count('\n') + 1
                                                                                                                                                                                                                                                                                                                        self.warnings['code_quality'].append(
                                                                                                                                                                                                                                                                                                                        f"{file_path}:{line_num} - Print statement detected"
                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                        # Check for long lines
                                                                                                                                                                                                                                                                                                                        for i, line in enumerate(lines, 1):
                                                                                                                                                                                                                                                                                                                            if len(line) > 120:
                                                                                                                                                                                                                                                                                                                                self.warnings['code_quality'].append(
                                                                                                                                                                                                                                                                                                                                f"{file_path}:{i} - Line too long ({len(line)} > 120 characters)"
                                                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                                                def _audit_dependencies(self):
                                                                                                                                                                                                                                                                                                                                    """Audit dependencies for security and compliance"""
                                                                                                                                                                                                                                                                                                                                    requirements_files = [
                                                                                                                                                                                                                                                                                                                                    'requirements.txt',
                                                                                                                                                                                                                                                                                                                                    'requirements_unified.txt',
                                                                                                                                                                                                                                                                                                                                    'requirements_mltrainer_system.txt',
                                                                                                                                                                                                                                                                                                                                    'requirements_py313.txt'
                                                                                                                                                                                                                                                                                                                                    ]

                                                                                                                                                                                                                                                                                                                                    all_deps = set()

                                                                                                                                                                                                                                                                                                                                    for req_file in requirements_files:
                                                                                                                                                                                                                                                                                                                                        if Path(req_file).exists():
                                                                                                                                                                                                                                                                                                                                            self.stats['dependencies_checked'] += 1
                                                                                                                                                                                                                                                                                                                                            with open(req_file, 'r') as f:
                                                                                                                                                                                                                                                                                                                                                for line in f:
                                                                                                                                                                                                                                                                                                                                                    line = line.strip()
                                                                                                                                                                                                                                                                                                                                                    if line and not line.startswith('#'):
                                                                                                                                                                                                                                                                                                                                                        # Extract package name
                                                                                                                                                                                                                                                                                                                                                        pkg = re.split('[<>=!]', line)[0].strip()
                                                                                                                                                                                                                                                                                                                                                        all_deps.add(pkg)

                                                                                                                                                                                                                                                                                                                                                        # Check for known problematic dependencies
                                                                                                                                                                                                                                                                                                                                                        problematic_deps = {
                                                                                                                                                                                                                                                                                                                                                        'pickle': 'Security risk - arbitrary code execution',
                                                                                                                                                                                                                                                                                                                                                        'eval': 'Security risk - code injection',
                                                                                                                                                                                                                                                                                                                                                        'exec': 'Security risk - code execution'
                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                        for dep in all_deps:
                                                                                                                                                                                                                                                                                                                                                            if dep.lower() in problematic_deps:
                                                                                                                                                                                                                                                                                                                                                                self.warnings['dependencies'].append(
                                                                                                                                                                                                                                                                                                                                                                f"{dep}: {problematic_deps[dep.lower()]}"
                                                                                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                                                                                # Check for outdated or insecure patterns
                                                                                                                                                                                                                                                                                                                                                                insecure_imports = [
                                                                                                                                                                                                                                                                                                                                                                'from pickle import',
                                                                                                                                                                                                                                                                                                                                                                'import pickle',
                                                                                                                                                                                                                                                                                                                                                                '# SECURITY: eval() disabled - eval(',
                                                                                                                                                                                                                                                                                                                                                                '# SECURITY: exec() disabled - exec(',
                                                                                                                                                                                                                                                                                                                                                                '__import__'
                                                                                                                                                                                                                                                                                                                                                                ]

                                                                                                                                                                                                                                                                                                                                                                for file_path in self._get_python_files():
                                                                                                                                                                                                                                                                                                                                                                    with open(file_path, 'r') as f:
                                                                                                                                                                                                                                                                                                                                                                        content = f.read()
                                                                                                                                                                                                                                                                                                                                                                        for pattern in insecure_imports:
                                                                                                                                                                                                                                                                                                                                                                            if pattern in content:
                                                                                                                                                                                                                                                                                                                                                                                self.violations['security'].append(
                                                                                                                                                                                                                                                                                                                                                                                f"{file_path} - Uses potentially insecure pattern: {pattern}"
                                                                                                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                                                                                                def _audit_all_dependencies(self):
                                                                                                                                                                                                                                                                                                                                                                                    """Audit all project dependencies"""
                                                                                                                                                                                                                                                                                                                                                                                    logger.info("\n📦 Auditing Dependencies# Production code implemented")
                                                                                                                                                                                                                                                                                                                                                                                    self._audit_dependencies()

                                                                                                                                                                                                                                                                                                                                                                                    def _audit_permissions(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                                                                                                                                                                                                        """Audit for autonomous execution without permission"""
                                                                                                                                                                                                                                                                                                                                                                                        # Check for automatic execution patterns
                                                                                                                                                                                                                                                                                                                                                                                        autonomous_patterns = [
                                                                                                                                                                                                                                                                                                                                                                                        r'\.run\(\)',
                                                                                                                                                                                                                                                                                                                                                                                        r'\.execute\(\)',
                                                                                                                                                                                                                                                                                                                                                                                        r'subprocess\.',
                                                                                                                                                                                                                                                                                                                                                                                        r'os\.system',
                                                                                                                                                                                                                                                                                                                                                                                        r'os\.exec'
                                                                                                                                                                                                                                                                                                                                                                                        ]

                                                                                                                                                                                                                                                                                                                                                                                        for pattern in autonomous_patterns:
                                                                                                                                                                                                                                                                                                                                                                                            if re.search(pattern, content):
                                                                                                                                                                                                                                                                                                                                                                                                # Check if there's permission checking nearby
                                                                                                                                                                                                                                                                                                                                                                                                if 'permission' not in content.lower() and 'confirm' not in content.lower():
                                                                                                                                                                                                                                                                                                                                                                                                    self.warnings['permissions'].append(
                                                                                                                                                                                                                                                                                                                                                                                                    f"{file_path} - Potential autonomous execution without permission check"
                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                    def _audit_documentation(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                                                                                                                                                                                                                        """Audit documentation completeness"""
                                                                                                                                                                                                                                                                                                                                                                                                        # Check for module docstring
                                                                                                                                                                                                                                                                                                                                                                                                        if isinstance(tree.body, list) and tree.body:
                                                                                                                                                                                                                                                                                                                                                                                                            first = tree.body[0]
                                                                                                                                                                                                                                                                                                                                                                                                            if not (isinstance(first, ast.Expr) and isinstance(first.value, ast.Str)):
                                                                                                                                                                                                                                                                                                                                                                                                                self.warnings['documentation'].append(
                                                                                                                                                                                                                                                                                                                                                                                                                f"{file_path} - Missing module docstring"
                                                                                                                                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                                                                                                                                # Check for function/class documentation
                                                                                                                                                                                                                                                                                                                                                                                                                class DocVisitor(ast.NodeVisitor):
                                                                                                                                                                                                                                                                                                                                                                                                                    def _deterministic_normal(self, mean=0.0, std=1.0, size=None):
                                                                                                                                                                                                                                                                                                                                                                                                                        """Deterministic normal distribution based on timestamp"""
                                                                                                                                                                                                                                                                                                                                                                                                                        import time
                                                                                                                                                                                                                                                                                                                                                                                                                        import numpy as np

                                                                                                                                                                                                                                                                                                                                                                                                                        # Use timestamp for deterministic seed
                                                                                                                                                                                                                                                                                                                                                                                                                        seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                                                                                                                                                                                        np.random.seed(seed)

                                                                                                                                                                                                                                                                                                                                                                                                                        if size is None:
                                                                                                                                                                                                                                                                                                                                                                                                                            return np.random.normal(mean, std)
                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                return np.random.normal(mean, std, size)

                                                                                                                                                                                                                                                                                                                                                                                                                                def _deterministic_uniform(self, low=0.0, high=1.0, size=None):
                                                                                                                                                                                                                                                                                                                                                                                                                                    """Deterministic uniform distribution"""
                                                                                                                                                                                                                                                                                                                                                                                                                                    import time
                                                                                                                                                                                                                                                                                                                                                                                                                                    import numpy as np

                                                                                                                                                                                                                                                                                                                                                                                                                                    seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                                                                                                                                                                                                    np.random.seed(seed)

                                                                                                                                                                                                                                                                                                                                                                                                                                    if size is None:
                                                                                                                                                                                                                                                                                                                                                                                                                                        return np.random.uniform(low, high)
                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                            return np.random.uniform(low, high, size)

                                                                                                                                                                                                                                                                                                                                                                                                                                            def _deterministic_randn(self, *args):
                                                                                                                                                                                                                                                                                                                                                                                                                                                """Deterministic random normal"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                import time
                                                                                                                                                                                                                                                                                                                                                                                                                                                import numpy as np

                                                                                                                                                                                                                                                                                                                                                                                                                                                seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                                                                                                                                                                                                                np.random.seed(seed)

                                                                                                                                                                                                                                                                                                                                                                                                                                                return np.random.randn(*args)

                                                                                                                                                                                                                                                                                                                                                                                                                                                def _deterministic_random(self, size=None):
                                                                                                                                                                                                                                                                                                                                                                                                                                                    """Deterministic random values"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                    import time
                                                                                                                                                                                                                                                                                                                                                                                                                                                    import numpy as np

                                                                                                                                                                                                                                                                                                                                                                                                                                                    seed = int(time.time() * 1000) % 1000000
                                                                                                                                                                                                                                                                                                                                                                                                                                                    np.random.seed(seed)

                                                                                                                                                                                                                                                                                                                                                                                                                                                    if size is None:
                                                                                                                                                                                                                                                                                                                                                                                                                                                        return np.random.random()
                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                            return np.random.random(size)
                                                                                                                                                                                                                                                                                                                                                                                                                                                            def __init__(self, auditor, file_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.auditor = auditor
                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.file_path = file_path

                                                                                                                                                                                                                                                                                                                                                                                                                                                                def visit_FunctionDef(self, node):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not ast.get_docstring(node) and not node.name.startswith('_'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.auditor.warnings['documentation'].append(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        f"{self.file_path}:{node.lineno} - Function '{node.name}' missing docstring"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.generic_visit(node)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def visit_ClassDef(self, node):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not ast.get_docstring(node):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.auditor.warnings['documentation'].append(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                f"{self.file_path}:{node.lineno} - Class '{node.name}' missing docstring"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.generic_visit(node)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                visitor = DocVisitor(self, file_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                visitor.visit(tree)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def _audit_security(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """Audit security best practices"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # SQL injection patterns
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sql_patterns = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    r'f["\'].*SELECT.*{.*}',  # f-string SQL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    r'%.*SELECT.*%',  # % formatting SQL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    r'\.format\(.*SELECT'  # .format() SQL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for pattern in sql_patterns:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if re.search(pattern, content, re.IGNORECASE):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.violations['security'].append(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            f"{file_path} - Potential SQL injection vulnerability"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Check for unsafe file operations
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if 'open(' in content:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Check if path is validated
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                open_calls = re.finditer(r'open\s*\([^)]+\)', content)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for match in open_calls:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if '..' in match.group() or '~' in match.group():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        line_num = content[:match.start()].count('\n') + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.violations['security'].append(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        f"{file_path}:{line_num} - Potentially unsafe file path"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def _audit_governance(self, file_path: Path, content: str, tree: ast.AST):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Audit governance compliance"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Check imports against governance rules
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            governance_imports = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'governance_kernel',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'governance_enforcement',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'agent_governance'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            uses_governance = any(imp in content for imp in governance_imports)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Files that should use governance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            should_use_governance = any(pattern in str(file_path) for pattern in [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'ml_engine', 'agent', 'core/'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ])

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if should_use_governance and not uses_governance and 'test_' not in str(file_path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.warnings['governance'].append(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                f"{file_path} - Core component not using governance framework"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def _audit_config_files(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """Audit configuration files"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.info("\n⚙️  Auditing Configuration Files# Production code implemented")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    config_files = list(Path('config').glob('*.py')) + list(Path('config').glob('*.yaml'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for config_file in config_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if config_file.suffix == '.yaml':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self._audit_yaml_config(config_file)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Python configs are already audited in main loop
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pass

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def _audit_yaml_config(self, file_path: Path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """Audit YAML configuration files"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    with open(file_path, 'r') as f:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        config = yaml.safe_load(f)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Check for sensitive data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sensitive_keys = ['password', 'secret', 'key', 'token']

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def check_dict_for_secrets(d, path=''):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if isinstance(d, dict):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for k, v in d.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if any(sensitive in k.lower() for sensitive in sensitive_keys):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if isinstance(v, str) and len(v) > 10 and not v.startswith('${'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.violations['api_keys'].append(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            f"{file_path} - Potential hardcoded secret in {path}.{k}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            check_dict_for_secrets(v, f"{path}.{k}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif isinstance(d, list):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for i, item in enumerate(d):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    check_dict_for_secrets(item, f"{path}[{i}]")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    check_dict_for_secrets(config)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.violations['config_errors'].append(f"{file_path}: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def _generate_report(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Generate comprehensive audit report"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info("\n" + "=" * 70)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info("📊 AUDIT REPORT")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info("=" * 70)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Statistics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"\n📈 Statistics:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"   Files scanned: {self.stats['files_scanned']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"   Total lines: {self.stats['total_lines']:,}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"   Dependencies checked: {self.stats['dependencies_checked']}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Critical Violations
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            critical_categories = ['synthetic_data', 'api_keys', 'security']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            critical_count = sum(len(self.violations.get(cat, [])) for cat in critical_categories)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if critical_count > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info(f"\n🚨 CRITICAL VIOLATIONS ({critical_count})")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info("-" * 50)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for category in critical_categories:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if category in self.violations:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f"\n{category.upper()}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for violation in self.violations[category][:10]:  # Show first 10
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f"   ❌ {violation}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(self.violations[category]) > 10:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"   # Production code implemented and {len(self.violations[category]) - 10} more")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Other Violations
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            other_violations = {k: v for k, v in self.violations.items() if k not in critical_categories}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if other_violations:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info(f"\n⚠️  OTHER VIOLATIONS")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info("-" * 50)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for category, items in other_violations.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if items:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f"\n{category.replace('_', ' ')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for item in items[:5]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"   ⚠️  {item}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if len(items) > 5:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info(f"   # Production code implemented and {len(items) - 5} more")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Warnings
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                total_warnings = sum(len(v) for v in self.warnings.values())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if total_warnings > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.warning(f"\n💡 WARNINGS ({total_warnings})")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.info("-" * 50)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for category, items in self.warnings.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if items:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"\n{category.replace('_', ' ')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for item in items[:3]:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info(f"   ℹ️  {item}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if len(items) > 3:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.info(f"   # Production code implemented and {len(items) - 3} more")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Compliance Summary
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.info(f"\n✅ COMPLIANCE SUMMARY")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.info("-" * 50)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    compliance_status = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'No Synthetic Data': len(self.violations.get('synthetic_data', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'No Hardcoded Keys': len(self.violations.get('api_keys', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Secure Code': len(self.violations.get('security', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Proper Error Handling': len(self.violations.get('error_handling', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Uses Approved Data Sources': len(self.warnings.get('data_sources', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Follows Governance': len(self.warnings.get('governance', [])) == 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for rule, status in compliance_status.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        icon = "✅" if status else "❌"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f"   {icon} {rule}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Agent Rules Compliance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f"\n📋 AGENT RULES COMPLIANCE")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info("-" * 50)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        rules_compliance = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'Never use synthetic or real_implementation data': len(self.violations.get('synthetic_data', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'Never hide information': total_warnings < 50,  # Reasonable threshold
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'Always provide complete truth': len(self.violations.get('error_handling', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'Data from approved sources only': len(self.warnings.get('data_sources', [])) == 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'No autonomous execution': len(self.warnings.get('permissions', [])) == 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for rule, compliant in rules_compliance.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            icon = "✅" if compliant else "❌"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"   {icon} {rule}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Final Status
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info("\n" + "=" * 70)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if critical_count == 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info("✅ AUDIT PASSED - No critical violations found")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    logger.error(f"❌ AUDIT FAILED - {critical_count} critical violations must be fixed")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Save detailed report
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self._save_detailed_report()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def _save_detailed_report(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """Save detailed audit report to file"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        report = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'timestamp': datetime.now().isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'statistics': self.stats,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'violations': dict(self.violations),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'warnings': dict(self.warnings),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'summary': {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'critical_violations': sum(len(self.violations.get(cat, []))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for cat in ['synthetic_data', 'api_keys', 'security']),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'total_violations': sum(len(v) for v in self.violations.values()),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'total_warnings': sum(len(v) for v in self.warnings.values())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        report_path = Path('audit_report.json')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with open(report_path, 'w') as f:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            json.dump(report, f, indent=2)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f"\n📄 Detailed report saved to: {report_path}")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def main():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """Run comprehensive audit"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                auditor = ComprehensiveAuditor()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    success = auditor.run_full_audit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if success:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info("\n✅ Codebase is compliant with agent rules and quality standards")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sys.exit(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info("\n❌ Critical compliance violations found - please fix before deployment")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sys.exit(1)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.error(f"\n❌ Audit error: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sys.exit(1)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    main()