name: mlTrainer CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Basic tests
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest
    
    - name: Run basic tests
      run: |
        # Run any test files that exist
        pytest tests/ -v || echo "No tests found"

  # Sync to Hugging Face
  sync-to-huggingface:
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        lfs: true
    
    - name: Push to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Configure git with HF token
        git config --global credential.helper store
        echo "https://hgw734:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
        
        # Clone HF space with token in URL
        git clone https://hgw734:${HF_TOKEN}@huggingface.co/spaces/hgw734/mltrainer3 hf-space
        cd hf-space
        
        # Configure git identity
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        
        # Copy all files from GitHub repo
        cp -r ../* . 2>/dev/null || true
        cp -r ../.streamlit . 2>/dev/null || true
        
        # Rename main file to app.py
        cp mltrainer_unified_chat.py app.py
        
        # Remove files that shouldn't be in HF
        rm -rf .git .github tests __pycache__ .pytest_cache
        
        # Commit and push
        git add .
        git commit -m "Update from GitHub - $(date)" || echo "No changes to commit"
        git push origin main
        
        echo "‚úÖ Deployed to Hugging Face Spaces!"
        echo "üîó https://huggingface.co/spaces/hgw734/mltrainer3"
        
        # Reminder about secrets
        echo ""
        echo "‚ö†Ô∏è Remember to set these secrets in your HF Space settings:"
        echo "   - ANTHROPIC_API_KEY"
        echo "   - POLYGON_API_KEY"
        echo "   - FRED_API_KEY"
        echo "   - TELEGRAM_BOT_TOKEN"
        echo "   - TELEGRAM_CHAT_ID"
