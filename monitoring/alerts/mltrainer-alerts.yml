groups:
  - name: mltrainer_api
    interval: 30s
    rules:
      # API availability
      - alert: MLTrainerAPIDown
        expr: up{job="mltrainer-api"} == 0
        for: 2m
        labels:
          severity: critical
          service: mltrainer-api
        annotations:
          summary: "mlTrainer API is down"
          description: "mlTrainer API has been down for more than 2 minutes"
      
      # High error rate
      - alert: MLTrainerHighErrorRate
        expr: rate(mltrainer_api_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: mltrainer-api
        annotations:
          summary: "High error rate in mlTrainer API"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"
      
      # Slow response time
      - alert: MLTrainerSlowResponse
        expr: histogram_quantile(0.95, rate(mltrainer_api_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: mltrainer-api
        annotations:
          summary: "Slow API response times"
          description: "95th percentile response time is {{ $value }}s"
      
      # High memory usage
      - alert: MLTrainerHighMemory
        expr: container_memory_usage_bytes{pod=~"mltrainer-api-.*"} / container_spec_memory_limit_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: mltrainer-api
        annotations:
          summary: "High memory usage in mlTrainer API"
          description: "Memory usage is {{ $value | humanizePercentage }} of limit"

  - name: mltrainer_models
    interval: 60s
    rules:
      # Model training failures
      - alert: ModelTrainingFailureRate
        expr: rate(mltrainer_model_training_failures_total[15m]) > 0.1
        for: 15m
        labels:
          severity: warning
          service: mltrainer-models
        annotations:
          summary: "High model training failure rate"
          description: "{{ $value | humanizePercentage }} of model trainings are failing"
      
      # Long running model training
      - alert: ModelTrainingStuck
        expr: mltrainer_model_training_duration_seconds > 3600
        for: 10m
        labels:
          severity: warning
          service: mltrainer-models
        annotations:
          summary: "Model training taking too long"
          description: "Model {{ $labels.model_id }} has been training for {{ $value | humanizeDuration }}"
      
      # Model prediction latency
      - alert: ModelPredictionSlow
        expr: histogram_quantile(0.99, rate(mltrainer_model_prediction_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: mltrainer-models
        annotations:
          summary: "Slow model predictions"
          description: "99th percentile prediction time is {{ $value }}s"

  - name: mltrainer_background
    interval: 60s
    rules:
      # Background job queue size
      - alert: BackgroundJobQueueHigh
        expr: mltrainer_background_queue_size > 1000
        for: 10m
        labels:
          severity: warning
          service: mltrainer-background
        annotations:
          summary: "Background job queue is growing"
          description: "{{ $value }} jobs in queue"
      
      # Failed background jobs
      - alert: BackgroundJobFailures
        expr: rate(mltrainer_background_job_failures_total[10m]) > 0.05
        for: 10m
        labels:
          severity: warning
          service: mltrainer-background
        annotations:
          summary: "Background jobs failing"
          description: "{{ $value | humanizePercentage }} failure rate"
      
      # Autonomous session failures
      - alert: AutonomousSessionFailures
        expr: rate(mltrainer_autonomous_session_failures_total[30m]) > 0.2
        for: 30m
        labels:
          severity: warning
          service: mltrainer-autonomous
        annotations:
          summary: "Autonomous sessions failing"
          description: "{{ $value | humanizePercentage }} of autonomous sessions are failing"

  - name: mltrainer_database
    interval: 30s
    rules:
      # Database connection pool exhaustion
      - alert: DatabaseConnectionPoolExhausted
        expr: mltrainer_db_connection_pool_available == 0
        for: 2m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection pool exhausted"
          description: "No available database connections"
      
      # Slow database queries
      - alert: DatabaseSlowQueries
        expr: histogram_quantile(0.95, rate(mltrainer_db_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Slow database queries"
          description: "95th percentile query time is {{ $value }}s"
      
      # Database disk space
      - alert: DatabaseDiskSpaceLow
        expr: pg_database_size_bytes / pg_tablespace_size_bytes > 0.85
        for: 10m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Database disk space running low"
          description: "Database using {{ $value | humanizePercentage }} of available space"

  - name: mltrainer_compliance
    interval: 60s
    rules:
      # Compliance violations
      - alert: ComplianceViolations
        expr: increase(mltrainer_compliance_violations_total[1h]) > 10
        for: 5m
        labels:
          severity: critical
          service: compliance
        annotations:
          summary: "Multiple compliance violations detected"
          description: "{{ $value }} compliance violations in the last hour"
      
      # Drift detection
      - alert: ModelDriftDetected
        expr: mltrainer_model_drift_score > 0.8
        for: 15m
        labels:
          severity: warning
          service: compliance
        annotations:
          summary: "Model drift detected"
          description: "Model {{ $labels.model_id }} drift score is {{ $value }}"

  - name: mltrainer_infrastructure
    interval: 30s
    rules:
      # Pod restarts
      - alert: PodRestartingTooOften
        expr: increase(kube_pod_container_status_restarts_total{namespace="mltrainer"}[1h]) > 5
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Pod restarting frequently"
          description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last hour"
      
      # Node disk pressure
      - alert: NodeDiskPressure
        expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Node disk pressure"
          description: "Node {{ $labels.node }} is experiencing disk pressure"
      
      # Certificate expiry
      - alert: CertificateExpiringSoon
        expr: (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "SSL certificate expiring soon"
          description: "Certificate for {{ $labels.instance }} expires in {{ $value }} days"